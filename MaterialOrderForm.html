<div class="material-order-form">
  <div class="form-header">
    <h2>Material Order Form</h2>
    <button onclick="returnToHome()" class="btn btn-secondary">Back to Home</button>
  </div>

  <div id="form-error" class="error-message" style="display:none;"></div>
  <div id="form-success" class="success-message" style="display:none;"></div>

  <form id="material-order-form">
    <div class="form-section">
      <h3>Job Information</h3>
      <div class="form-group">
        <label for="jobId">Job Number:</label>
        <input type="text" id="jobId" name="jobId" required>
      </div>
      <div class="form-group">
        <label for="jobAddress">Job Address:</label>
        <textarea id="jobAddress" name="jobAddress" rows="2" readonly></textarea>
      </div>
    </div>

    <div class="form-section">
      <h3>Delivery Information</h3>
      <div class="form-group">
        <label for="deliveryType">Delivery Type:</label>
        <select id="deliveryType" name="deliveryType" required>
          <option value="Will Call">Will Call</option>
          <option value="Delivery">Delivery</option>
        </select>
      </div>
      <div class="form-group" id="delivery-address-group" style="display:none;">
        <label for="deliveryAddress">Delivery Address:</label>
        <textarea id="deliveryAddress" name="deliveryAddress" rows="2"></textarea>
      </div>
      <div class="form-group">
        <label for="requestedDate">Requested Date:</label>
        <input type="date" id="requestedDate" name="requestedDate" required>
      </div>
    </div>

    <div class="form-section">
      <h3>Order Items</h3>
      <div class="tabs">
        <div class="tab-buttons">
          <button type="button" class="tab-button active" data-tab="paint">Paint</button>
          <button type="button" class="tab-button" data-tab="sundries">Sundries</button>
        </div>
        <div class="tab-content">
          <div class="tab-pane active" id="paint-tab">
            <div class="form-group">
              <label for="paintVendor">Paint Vendor:</label>
              <select id="paintVendor">
                <option value="">-- Select Vendor --</option>
              </select>
            </div>
            <div class="form-group">
              <label for="paintType">Paint Type:</label>
              <select id="paintType">
                <option value="">-- Select Type --</option>
              </select>
            </div>
            <div id="paint-products-container" class="products-grid"></div>
          </div>
          <div class="tab-pane" id="sundries-tab">
            <div class="form-group">
              <label for="sundriesCategory">Sundries Category:</label>
              <select id="sundriesCategory">
                <option value="">-- Select Category --</option>
              </select>
            </div>
            <div id="sundries-container" class="products-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h4>Selected Items</h4>
      <div id="selected-items-container">
        <table class="selected-items-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="selected-items-body">
            <tr id="no-items-row">
              <td colspan="4" class="text-center">No items selected</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="form-section">
      <h3>Additional Information</h3>
      <div class="form-group">
        <label for="notes">Order Notes:</label>
        <textarea id="notes" name="notes" rows="3"></textarea>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Submit Order</button>
      <button type="button" class="btn btn-secondary" onclick="returnToHome()">Cancel</button>
    </div>
  </form>
</div>
<?!= HtmlService.createHtmlOutputFromFile('MaterialOrderFormScript').getContent(); ?>


<script>
  <?!= include('MaterialOrderFormScript'); ?>
  let allProducts = [];
  let allSundries = [];
  let selectedItems = [];

  document.addEventListener('DOMContentLoaded', function () {
    const paintVendorSelect = document.getElementById('paintVendor');
    const paintTypeSelect = document.getElementById('paintType');
    const sundriesCategorySelect = document.getElementById('sundriesCategory');

    // Load vendors
    google.script.run.withSuccessHandler(function(vendors) {
      const seen = new Set();
      vendors.forEach(row => {
        const name = row[0]; // Column A = Name
        if (name && !seen.has(name)) {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          paintVendorSelect.appendChild(option);
          seen.add(name);
        }
      });
    }).getVendors();

    // Load paint types (categories)
    google.script.run.withSuccessHandler(function(categories) {
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        paintTypeSelect.appendChild(option);
      });
    }).getProductCategories();

    // Load products
    google.script.run.withSuccessHandler(function(products) {
      allProducts = products;
      paintVendorSelect.addEventListener('change', filterPaintProducts);
      paintTypeSelect.addEventListener('change', filterPaintProducts);
    }).getProducts();

    // Load sundries
    google.script.run.withSuccessHandler(function(sundries) {
      allSundries = sundries;
      const seen = new Set();
      sundries.forEach(item => {
        if (item.category && !seen.has(item.category)) {
          const option = document.createElement('option');
          option.value = item.category;
          option.textContent = item.category;
          sundriesCategorySelect.appendChild(option);
          seen.add(item.category);
        }
      });
      sundriesCategorySelect.addEventListener('change', filterSundries);
    }).getSundries();
  });

  function filterPaintProducts() {
    const vendorName = document.getElementById('paintVendor').value;
    const paintType = document.getElementById('paintType').value;
    const container = document.getElementById('paint-products-container');

    const filtered = allProducts.filter(product => {
      return (!vendorName || product.vendorName === vendorName) &&
             (!paintType || product.category === paintType);
    });

    container.innerHTML = '';
    if (filtered.length === 0) {
      container.innerHTML = '<p class="no-results">No matching paint products found</p>';
      return;
    }

    filtered.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <h4>${product.name}</h4>
        <p>${product.category || ''}</p>
        <input type="number" min="1" value="1" class="product-qty">
        <button class="btn btn-primary">Add</button>
      `;
      card.querySelector('button').addEventListener('click', () => {
        const qty = parseInt(card.querySelector('.product-qty').value);
        addItem(product, qty);
      });
      container.appendChild(card);
    });
  }

  function filterSundries() {
    const category = document.getElementById('sundriesCategory').value;
    const container = document.getElementById('sundries-container');
    const filtered = allSundries.filter(item => !category || item.category === category);

    container.innerHTML = '';
    if (filtered.length === 0) {
      container.innerHTML = '<p class="no-results">No matching sundries found</p>';
      return;
    }

    filtered.forEach(item => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <h4>${item.name}</h4>
        <p>${item.category}</p>
        <input type="number" min="1" value="1" class="product-qty">
        <button class="btn btn-primary">Add</button>
      `;
      card.querySelector('button').addEventListener('click', () => {
        const qty = parseInt(card.querySelector('.product-qty').value);
        addItem(item, qty);
      });
      container.appendChild(card);
    });
  }

  function addItem(product, quantity) {
    const existing = selectedItems.find(i => i.id === product.id);
    if (existing) {
      existing.quantity += quantity;
    } else {
      selectedItems.push({ ...product, quantity });
    }
    renderSelectedItems();
  }
function initializeTabs() {
  var tabButtons = document.querySelectorAll('.tab-button');

  tabButtons.forEach(function(button) {
    button.addEventListener('click', function() {
      document.querySelectorAll('.tab-button').forEach(function(btn) {
        btn.classList.remove('active');
      });

      document.querySelectorAll('.tab-pane').forEach(function(pane) {
        pane.classList.remove('active');
      });

      this.classList.add('active');
      var tabId = this.getAttribute('data-tab') + '-tab';
      document.getElementById(tabId).classList.add('active');
    });
  });
}

  function renderSelectedItems() {
    const tbody = document.getElementById('selected-items-body');
    tbody.innerHTML = '';
    if (selectedItems.length === 0) {
      tbody.innerHTML = '<tr id="no-items-row"><td colspan="4" class="text-center">No items selected</td></tr>';
      return;
    }
    selectedItems.forEach((item, idx) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td><input type="number" min="1" value="${item.quantity}" data-idx="${idx}" class="update-qty"></td>
        <td><input type="text" value="${item.notes || ''}" data-idx="${idx}" class="update-note"></td>
        <td><button class="btn btn-danger" data-idx="${idx}">Remove</button></td>
      `;
      row.querySelector('.update-qty').addEventListener('change', e => {
        selectedItems[idx].quantity = parseInt(e.target.value);
      });
      row.querySelector('.update-note').addEventListener('change', e => {
        selectedItems[idx].notes = e.target.value;
      });
      row.querySelector('button').addEventListener('click', () => {
        selectedItems.splice(idx, 1);
        renderSelectedItems();
      });
      tbody.appendChild(row);
    });
  }
</script>

